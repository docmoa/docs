# 안전한 RAG 시스템 구축: HashiCorp Vault와 Amazon Bedrock 활용

## 개요

AI 기술의 발전과 함께 기업들은 데이터를 더 똑똑하게 활용하기 위한 다양한 시도를 하고 있습니다. 특히, `생성형 AI(GenAI)`와 `대규모 언어 모델(LLM)`은 데이터 분석과 사용자 경험을 혁신하고 있습니다. 하지만, 사전에 학습된 데이터만을 기반으로 하는 LLM은 최신 정보에 대한 접근이 제한적이라는 한계를 가지고 있습니다.

이러한 한계를 해결하는 기술이 바로 `Retrieval-Augmented Generation (RAG)`입니다. RAG는 모델이 외부 데이터 소스를 검색하여 최신 정보를 통합한 답변을 제공할 수 있게 합니다. 기업은 이 기술을 활용해 자체 지식 기반을 바탕으로 사용자에게 최신 정보와 맞춤형 응답을 제공할 수 있습니다. 그러나 RAG 시스템은 개인정보(PII), 민감정보, 클라우드 자격 증명 등 기업의 중요한 데이터를 처리하기 때문에 데이터 보호와 보안이 필수적입니다.

HashiCorp Vault는 이러한 RAG 시스템을 안전하게 보호하는 데 중요한 역할을 합니다. Vault의 강력한 `암호화 기능(Transit, Tokenization, Masking, FPE 등)`은 데이터를 안전하게 암호화하고, 규제와 컴플라이언스를 충족할 수 있도록 지원합니다. 

![참고: Vault Masking 기능을 활용한 안전한 데이터 파이프라인 예시](./image/rag.png)

본 포스팅에서는 AWS 환경에서 Amazon Bedrock과 함께 RAG를 구축하는 방안을 소개하며, Vault를 통해 민감정보를 안전하게 보호하는 방법을 설명합니다.

::: tip 💡 감사한 분(Special Thanks)
본 글은 HashiCorp의 [David Wright](https://www.linkedin.com/in/david-wright-57336a4/)의 [GitHub 저장소](https://github.com/dawright22/aws-rag-terraform-deployment-demo) 데모 시나리오를 분석 및 참고하여 작성되었습니다.
:::

## 도입부: AI와 LLM, 그리고 GenAI

### AI 기술의 발전과 LLM의 등장
최근 AI는 기업의 데이터 활용 방식에 중요한 변화를 가져오고 있습니다. 특히, 대규모 언어 모델(LLM)은 사용자의 입력을 이해하고, 의미 있는 응답을 생성할 수 있어 다양한 응용 사례를 만들어내고 있습니다. 이 중에서도 생성형 AI(GenAI)는 기업이 데이터를 활용해 새로운 가치를 창출할 수 있는 강력한 도구로 자리 잡았습니다.

### RAG의 필요성
기존 LLM은 사전에 학습된 데이터만을 기반으로 동작하며, 학습 이후 생성된 최신 데이터에는 접근할 수 없습니다. 이 한계를 극복하기 위해 등장한 기술이 바로 **Retrieval-Augmented Generation (RAG)** 입니다.

#### RAG의 주요 특징:
1. **외부 데이터 검색**:
   - 문서, 데이터베이스, API 등 외부 소스에서 최신 데이터를 검색하여 모델에 통합.
2. **유연한 데이터 업데이트**:
   - 기존 모델을 재학습하지 않고도 새로운 데이터를 쉽게 반영.

#### RAG vs. 파인튜닝:
- **비용 효율성**: 별도의 모델 재학습 과정이 필요하지 않아 비용과 시간이 절약.
- **유연성**: 외부 데이터 소스를 변경함으로써 다양한 질문에 대응 가능.

![RAG vs 파인튜닝(출처: 스켈터랩스)](./image/rag-finetuning.png)

## HashiCorp Vault를 활용한 RAG 시스템 보호

RAG 시스템은 외부 데이터를 검색하고 이를 처리하는 과정에서 **민감정보(PII, 시크릿, 기밀 데이터)** 를 포함할 가능성이 큽니다. 이러한 데이터를 안전하게 관리하지 않으면 데이터 유출, 규제 위반, 기업 신뢰 손실로 이어질 수 있습니다.

### 왜 RAG 시스템이 안전하게 관리되어야 하는가?
#### 1) **컴플라이언스와 규제 준수**
- **GDPR, CCPA, HIPAA** 와 같은 글로벌 데이터 보호 규정은 개인정보와 민감정보를 안전하게 관리할 것을 요구합니다.
- Vault를 사용하면 이러한 규정을 충족하기 위해 필요한 암호화, 액세스 제어, 로그 기록 등을 효과적으로 구현할 수 있습니다.

#### 2) **거버넌스와 보안 강화**
- 기업은 데이터를 중앙에서 관리하며, 누가 어떤 데이터를 사용하는지 명확히 추적해야 합니다.
- Vault는 암호화 키 관리와 동적 자격 증명 제공으로 데이터 거버넌스를 강화합니다.

#### 3) **데이터 유출 방지**
- 문서 데이터나 검색 결과가 외부로 유출될 경우, 암호화된 데이터는 안전성을 유지합니다.

### Vault의 주요 암호화 기능

HashiCorp Vault는 RAG 시스템에서 발생하는 보안 문제를 해결하기 위해 다양한 암호화 기능을 제공합니다:

#### 1) Transit 암호화
- 특징: 데이터베이스나 파일 시스템에 저장되는 데이터를 실시간으로 암호화 및 복호화.
- 설명: Vault의 Transit 엔진은 데이터를 저장하기 전에 암호화하고, 읽어올 때 복호화하여 민감 데이터가 암호화된 상태로만 저장되도록 보장합니다. 저장된 데이터는 Vault 키를 사용해 보호되며, 데이터베이스와 파일 시스템의 직접 암호화 요구를 충족합니다.


#### 2) 형식 보존 암호화 (FPE, Format-Preserving Encryption)
- 특징: 데이터의 원래 형식을 유지하면서 암호화하여 데이터 분석 및 처리 시에도 활용 가능.
- 설명: 예를 들어, 신용카드 번호 `1234-5678-9101-1121`을 `9834-2647-8101-7532`와 같이 형식을 유지한 상태로 암호화합니다. Vault의 Transform 엔진을 통해 적용되며, 데이터 분석 및 처리가 필요한 환경에서 특히 유용합니다.


#### 3) 데이터 마스킹 (Masking)
- 특징: 데이터 조회 시 민감한 정보를 제거하거나 대체하여 접근 권한이 없는 사용자의 데이터 노출을 최소화.
- 설명: Vault는 데이터를 읽을 때 특정 필드를 마스킹 처리하여 민감 정보의 가시성을 제한합니다. 예를들어 신용카드 번호를 `****-****-****-1234` 형식으로 마스킹 처리할 수 있습니다.


#### 4) 스토리지 레벨 암호화 (TDE, Transparent Data Encryption)
- 특징: 데이터가 저장될 때 데이터베이스나 스토리지 계층에서 암호화를 수행.
- 설명: `Oracle TDE`나 `MSSQL TDE`와 같은 데이터베이스 자체의 암호화 기능과 Vault를 통합하여, 저장소 레벨에서 데이터를 암호화 및 보호합니다. 데이터가 직접적으로 유출되더라도 복호화 키 없이는 읽을 수 없습니다.

![참고: Vault을 활용한 암호화 방안 통합 아키텍처](./image/encryption_architecture.png)

## Vault의 도입 효과
Vault를 활용하면 다음과 같은 효과를 얻을 수 있습니다:
1. **컴플라이언스 준수**:
   - GDPR, HIPAA 등 규제를 충족하며, 감사 및 보고를 지원.
2. **데이터 유출 방지**:
   - 암호화된 데이터는 유출되더라도 안전성을 유지.
3. **중앙 집중 관리**:
   - 암호화 키와 데이터를 중앙에서 관리하여 데이터 거버넌스를 강화.

## 구현 방안: GitHub Terraform 코드와 샘플 코드 활용

::: tip Terraform 코드와 샘플 코드
Vault와 RAG를 통합한 상세한 구현 방법은 GitHub에 업로드된 [Terraform 코드와 샘플 코드](https://github.com/hyungwook0221/aws-rag-terraform-deployment-demo)를 참고하세요.
:::

구현 기술:
- **FAISS**: 문서 벡터화 및 검색.
- **LangChain**: 데이터 검색과 LLM 통합.
- **Streamlit**: 사용자 인터페이스 구성.
- **Amazon Bedrock**: LLM을 통한 응답 생성.
- **HashiCorp Vault**: 데이터 암호화 기능 제공.

![사진: 주요 컴포넌트 로고](./image/component.png)

## 주요 동작 프로세스
```mermaid
graph TD
    시작["시작"] --> 문서업로드["지식 베이스 문서 업로드 (Streamlit)"]
    문서업로드 --> 민감정보암호화["민감 정보 암호화 (Vault Transit)"]
    민감정보암호화 --> 벡터생성["벡터 생성 (FAISS)"]
    벡터생성 --> 벡터저장["벡터 저장 (FAISS)"]
    질문입력["질문 입력 (Streamlit)"] --> 데이터검색["관련 데이터 검색 (FAISS)"]
    데이터검색 --> 데이터조회["데이터 조회 및 LLM 호출 (LangChain)"]
    데이터조회 --> 답변생성["답변 생성 (AWS Bedrock)"]
    답변생성 --> 답변출력["답변 출력 (Streamlit)"]
    답변출력 --> 끝["끝"]
```

::: tip 💡 핸즈온 실습 
각종 구성요소와 동작 방식에 대한 설명은 👉 [여기](https://github.com/hyungwook0221/aws-rag-terraform-deployment-demo)에서 확인하실 수 있습니다.
:::